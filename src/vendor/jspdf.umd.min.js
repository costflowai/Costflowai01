const escapeText = (value) => value.replace(/\\/g, "\\\\").replace(/\(/g, "\\(").replace(/\)/g, "\\)");

const buildPdf = (lines) => {
  const header = '%PDF-1.1\n';
  const objects = [];
  objects.push('1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj\n');
  objects.push('2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj\n');
  objects.push('3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >> endobj\n');
  const content = lines.length
    ? lines.map(({ text, x, y, size }) => `BT /F1 ${size.toFixed(2)} Tf ${x.toFixed(2)} ${y.toFixed(2)} Td (${escapeText(text)}) Tj ET`).join('\n')
    : 'BT /F1 16 Tf 72 720 Td (No content) Tj ET';
  const stream = `4 0 obj << /Length ${content.length} >> stream\n${content}\nendstream endobj\n`;
  objects.push(stream);
  objects.push('5 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj\n');

  let body = header;
  const xref = ['xref\n0 6\n0000000000 65535 f \n'];
  const offsets = [0];

  objects.forEach((obj, index) => {
    const offset = body.length;
    offsets.push(offset);
    body += obj;
  });

  for (let i = 1; i < offsets.length; i += 1) {
    xref.push(`${String(offsets[i]).padStart(10, '0')} 00000 n \n`);
  }

  const trailer = 'trailer << /Size 6 /Root 1 0 R >>\nstartxref\n';
  const startxref = body.length;
  body += xref.join('');
  body += trailer;
  body += `${startxref}\n%%EOF`;
  return body;
};

class SimplePDF {
  constructor() {
    this.lines = [];
  }

  text(text, x, y, options = {}) {
    const size = typeof options.size === 'number' && options.size > 0 ? options.size : 12;
    this.lines.push({ text: String(text), x, y, size });
  }

  save(filename = 'document.pdf') {
    const pdfString = buildPdf(this.lines);
    const blob = new Blob([pdfString], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setTimeout(() => URL.revokeObjectURL(url), 0);
  }
}

export const jsPDF = SimplePDF;
