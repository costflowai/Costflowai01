<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;">
    <title>Project Cash Flow Calculator - Finance Plan | CostFlowAI</title>
    <meta name="description" content="Analyze project cash flow, track payments, and manage construction financing. Professional project financial planning calculator.">
    <link rel="canonical" href="https://costflowai.com/calculators/project-cash-flow.html">
    <link rel="stylesheet" href="../assets/css/calculator.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <a href="../index.html">
                    <img src="../assets/images/logo.png" alt="CostFlow AI" class="logo">
                </a>
            </div>
            <nav class="nav">
                <a href="../index.html">Home</a>
                <a href="../calculators/index.html">Calculators</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="calc-container" id="cash-flow-calc" data-calc="cash-flow">
                <div class="calc-header">
                    <h1><i class="fas fa-chart-line"></i> Project Cash Flow Calculator</h1>
                    <p>Draw schedules, billing analysis, and ROI calculations for construction projects</p>
                </div>

                <div class="calc-content">
                    <div class="input-section">
                        <div class="card">
                            <h3><i class="fas fa-project-diagram"></i> Project Overview</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="projectName">Project Name</label>
                                    <input type="text" id="projectName" value="Sample Construction Project" placeholder="Enter project name">
                                </div>
                                <div class="form-group">
                                    <label for="contractValue">Total Contract Value ($)</label>
                                    <input type="number" id="contractValue" value="500000" min="10000" step="1000">
                                </div>
                                <div class="form-group">
                                    <label for="projectDuration">Project Duration (months)</label>
                                    <input type="number" id="projectDuration" value="8" min="1" max="60" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="contractType">Contract Type</label>
                                    <select id="contractType">
                                        <option value="lump-sum" selected>Lump Sum</option>
                                        <option value="cost-plus">Cost Plus</option>
                                        <option value="time-materials">Time & Materials</option>
                                        <option value="unit-price">Unit Price</option>
                                        <option value="design-build">Design-Build</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-calendar-check"></i> Draw Schedule</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="drawFrequency">Draw Frequency</label>
                                    <select id="drawFrequency">
                                        <option value="weekly">Weekly</option>
                                        <option value="bi-weekly">Bi-Weekly</option>
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="milestone">Milestone Based</option>
                                        <option value="completion">% Completion</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="retentionRate">Retention Rate (%)</label>
                                    <input type="number" id="retentionRate" value="10" min="0" max="20" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="drawProcessingTime">Draw Processing Time (days)</label>
                                    <input type="number" id="drawProcessingTime" value="30" min="7" max="60" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="downPayment">Down Payment (%)</label>
                                    <input type="number" id="downPayment" value="10" min="0" max="50" step="1">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-money-bill-wave"></i> Cost Structure</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="laborCostPercent">Labor Cost (%)</label>
                                    <input type="number" id="laborCostPercent" value="35" min="10" max="80" step="5">
                                </div>
                                <div class="form-group">
                                    <label for="materialCostPercent">Material Cost (%)</label>
                                    <input type="number" id="materialCostPercent" value="40" min="10" max="70" step="5">
                                </div>
                                <div class="form-group">
                                    <label for="equipmentCostPercent">Equipment Cost (%)</label>
                                    <input type="number" id="equipmentCostPercent" value="10" min="0" max="30" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="overheadPercent">Overhead (%)</label>
                                    <input type="number" id="overheadPercent" value="15" min="5" max="25" step="1">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-clock"></i> Timing & Scheduling</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="projectStart">Project Start Date</label>
                                    <input type="date" id="projectStart" value="">
                                </div>
                                <div class="form-group">
                                    <label for="frontLoad">Front Loading (%)</label>
                                    <input type="number" id="frontLoad" value="5" min="0" max="25" step="1">
                                    <small>Higher initial billing percentage</small>
                                </div>
                                <div class="form-group">
                                    <label for="mobilizationPercent">Mobilization (%)</label>
                                    <input type="number" id="mobilizationPercent" value="5" min="0" max="15" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="seasonalVariation">Seasonal Variation</label>
                                    <select id="seasonalVariation">
                                        <option value="none" selected>No Variation</option>
                                        <option value="winter-slow">Slower in Winter</option>
                                        <option value="summer-peak">Peak in Summer</option>
                                        <option value="weather-dependent">Weather Dependent</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-piggy-bank"></i> Financial Parameters</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="interestRate">Interest Rate (%)</label>
                                    <input type="number" id="interestRate" value="6.5" min="0" max="20" step="0.25">
                                </div>
                                <div class="form-group">
                                    <label for="bondRate">Bond Rate (%)</label>
                                    <input type="number" id="bondRate" value="2.5" min="0" max="5" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="initialCashOutlay">Initial Cash Outlay ($)</label>
                                    <input type="number" id="initialCashOutlay" value="25000" min="0" step="1000">
                                </div>
                                <div class="form-group">
                                    <label for="workingCapitalDays">Working Capital (days)</label>
                                    <input type="number" id="workingCapitalDays" value="45" min="15" max="120" step="5">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Risk Factors</h3>
                            <div class="input-grid">
                                <div class="form-group">
                                    <label for="changeOrderPercent">Expected Change Orders (%)</label>
                                    <input type="number" id="changeOrderPercent" value="8" min="0" max="30" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="delayRisk">Schedule Delay Risk</label>
                                    <select id="delayRisk">
                                        <option value="low" selected>Low (0-10%)</option>
                                        <option value="moderate">Moderate (10-25%)</option>
                                        <option value="high">High (25-50%)</option>
                                        <option value="very-high">Very High (>50%)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="paymentRisk">Payment Risk</label>
                                    <select id="paymentRisk">
                                        <option value="low" selected>Low (Gov/Prime)</option>
                                        <option value="moderate">Moderate</option>
                                        <option value="high">High (New Client)</option>
                                        <option value="very-high">Very High</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="contingencyPercent">Contingency (%)</label>
                                    <input type="number" id="contingencyPercent" value="5" min="0" max="15" step="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="results-section">
                        <div class="card">
                            <h3><i class="fas fa-chart-line"></i> Cash Flow Summary</h3>
                            <div class="results-grid">
                                <div class="result-item">
                                    <span class="label">Peak Cash Need:</span>
                                    <span class="value highlight" id="peakCashNeed">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Project ROI:</span>
                                    <span class="value highlight" id="projectROI">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Breakeven Point:</span>
                                    <span class="value" id="breakevenPoint">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Final Profit:</span>
                                    <span class="value" id="finalProfit">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-money-check-alt"></i> Draw Schedule Analysis</h3>
                            <div class="results-grid">
                                <div class="result-item">
                                    <span class="label">Number of Draws:</span>
                                    <span class="value" id="numberOfDraws">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Average Draw Amount:</span>
                                    <span class="value" id="averageDrawAmount">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Total Retention:</span>
                                    <span class="value" id="totalRetention">-</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Cash Conversion Cycle:</span>
                                    <span class="value" id="cashConversionCycle">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-chart-area"></i> Monthly Cash Flow Projection</h3>
                            <div id="cashFlowChart" class="chart-container">
                                <!-- Cash flow chart will be populated here -->
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-table"></i> Detailed Draw Schedule</h3>
                            <div id="drawScheduleTable" class="table-container">
                                <!-- Draw schedule table will be populated here -->
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-exclamation-circle"></i> Risk Analysis</h3>
                            <div id="riskAnalysis" class="risk-analysis">
                                <!-- Risk analysis will be populated here -->
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-lightbulb"></i> Cash Flow Optimization</h3>
                            <div id="optimizationTips" class="optimization-tips">
                                <!-- Optimization recommendations will be populated here -->
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-calculator"></i> Financial Metrics</h3>
                            <div class="financial-metrics">
                                <div class="metric-row">
                                    <span>Net Present Value (NPV):</span>
                                    <span id="netPresentValue">$0</span>
                                </div>
                                <div class="metric-row">
                                    <span>Internal Rate of Return (IRR):</span>
                                    <span id="internalRateOfReturn">0%</span>
                                </div>
                                <div class="metric-row">
                                    <span>Payback Period:</span>
                                    <span id="paybackPeriod">0 months</span>
                                </div>
                                <div class="metric-row">
                                    <span>Working Capital Requirement:</span>
                                    <span id="workingCapitalReq">$0</span>
                                </div>
                                <div class="metric-row">
                                    <span>Interest Carrying Cost:</span>
                                    <span id="interestCarryingCost">$0</span>
                                </div>
                                <div class="metric-row">
                                    <span>Bond Cost:</span>
                                    <span id="bondCost">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calc-actions">
                    <button onclick="calculator.saveCalculation()" data-action="save"><i class="fas fa-save"></i> Save</button>
                    <button onclick="calculator.exportCSV()" data-action="export"><i class="fas fa-download"></i> Export CSV</button>
                    <button onclick="calculator.shareLink()"><i class="fas fa-share"></i> Share Link</button>
                    <button onclick="calculator.printResults()" data-action="print"><i class="fas fa-print"></i> Print</button>
                </div>

                <div class="methodology-section">
                    <div class="card">
                        <h3><i class="fas fa-info-circle"></i> Calculation Methodology</h3>
                        <div class="methodology-content">
                            <h4>Cash Flow Modeling:</h4>
                            <p>• Monthly cash flows calculated based on work progress curves</p>
                            <p>• Cost timing adjusted for material delivery and labor patterns</p>
                            <p>• Payment delays and retention schedules integrated into projections</p>
                            
                            <h4>ROI Calculations:</h4>
                            <p>• Net Present Value using weighted average cost of capital</p>
                            <p>• IRR calculated from monthly cash flow streams</p>
                            <p>• Risk-adjusted returns account for schedule and payment uncertainties</p>
                            
                            <h4>Working Capital:</h4>
                            <p>• Peak funding requirements based on payment timing gaps</p>
                            <p>• Interest costs calculated on negative cash flow periods</p>
                            <p>• Opportunity costs of retained funds included in analysis</p>
                            
                            <h4>Risk Assessment:</h4>
                            <p>• Monte Carlo simulation for schedule delay scenarios</p>
                            <p>• Change order impact on cash flow timing</p>
                            <p>• Payment risk probability weighted outcomes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 CostFlow AI. Professional construction cost analysis.</p>
        </div>
    </footer>

    <script src="../assets/js/calculator-core.js"></script>
    <script src="/assets/js/calculators.js" defer></script>
    <script src="/assets/js/export-utilities.js" defer></script>
    <script src="/assets/js/calculators-hub.js" defer></script>
    <script>
        class ProjectCashFlowCalculator extends ProCalculator {
            constructor() {
                super('Project Cash Flow Calculator');
                this.initializeCalculator();
            }

            initializeCalculator() {
                const inputs = [
                    'projectName', 'contractValue', 'projectDuration', 'contractType',
                    'drawFrequency', 'retentionRate', 'drawProcessingTime', 'downPayment',
                    'laborCostPercent', 'materialCostPercent', 'equipmentCostPercent', 'overheadPercent',
                    'projectStart', 'frontLoad', 'mobilizationPercent', 'seasonalVariation',
                    'interestRate', 'bondRate', 'initialCashOutlay', 'workingCapitalDays',
                    'changeOrderPercent', 'delayRisk', 'paymentRisk', 'contingencyPercent'
                ];

                inputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.calculate());
                        element.addEventListener('change', () => this.calculate());
                    }
                });

                // Set default project start date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('projectStart').value = today;

                this.loadFromURL();
                this.calculate();
            }

            calculate() {
                this.collectInputs();
                this.generateCashFlowProjection();
                this.calculateFinancialMetrics();
                this.analyzeRisks();
                this.generateOptimizationTips();
                this.displayResults();
                this.updateInputs();
            }

            collectInputs() {
                this.inputs = {
                    projectName: document.getElementById('projectName').value || 'Sample Construction Project',
                    contractValue: parseFloat(document.getElementById('contractValue').value) || 500000,
                    projectDuration: parseFloat(document.getElementById('projectDuration').value) || 8,
                    contractType: document.getElementById('contractType').value || 'lump-sum',
                    drawFrequency: document.getElementById('drawFrequency').value || 'monthly',
                    retentionRate: parseFloat(document.getElementById('retentionRate').value) || 10,
                    drawProcessingTime: parseFloat(document.getElementById('drawProcessingTime').value) || 30,
                    downPayment: parseFloat(document.getElementById('downPayment').value) || 10,
                    laborCostPercent: parseFloat(document.getElementById('laborCostPercent').value) || 35,
                    materialCostPercent: parseFloat(document.getElementById('materialCostPercent').value) || 40,
                    equipmentCostPercent: parseFloat(document.getElementById('equipmentCostPercent').value) || 10,
                    overheadPercent: parseFloat(document.getElementById('overheadPercent').value) || 15,
                    projectStart: document.getElementById('projectStart').value || new Date().toISOString().split('T')[0],
                    frontLoad: parseFloat(document.getElementById('frontLoad').value) || 5,
                    mobilizationPercent: parseFloat(document.getElementById('mobilizationPercent').value) || 5,
                    seasonalVariation: document.getElementById('seasonalVariation').value || 'none',
                    interestRate: parseFloat(document.getElementById('interestRate').value) || 6.5,
                    bondRate: parseFloat(document.getElementById('bondRate').value) || 2.5,
                    initialCashOutlay: parseFloat(document.getElementById('initialCashOutlay').value) || 25000,
                    workingCapitalDays: parseFloat(document.getElementById('workingCapitalDays').value) || 45,
                    changeOrderPercent: parseFloat(document.getElementById('changeOrderPercent').value) || 8,
                    delayRisk: document.getElementById('delayRisk').value || 'low',
                    paymentRisk: document.getElementById('paymentRisk').value || 'low',
                    contingencyPercent: parseFloat(document.getElementById('contingencyPercent').value) || 5
                };
                
                // Validate cost percentages add up to 100%
                const totalCostPercent = this.inputs.laborCostPercent + this.inputs.materialCostPercent + 
                    this.inputs.equipmentCostPercent + this.inputs.overheadPercent;
                if (Math.abs(totalCostPercent - 100) > 1) {
                    console.warn('Cost percentages do not add up to 100%');
                }
            }

            generateCashFlowProjection() {
                const monthlyData = [];
                const totalMonths = Math.ceil(this.inputs.projectDuration);
                
                // Calculate draw frequency in months
                const drawFrequencyMonths = this.getDrawFrequencyInMonths();
                this.results.numberOfDraws = Math.ceil(totalMonths / drawFrequencyMonths);
                
                // Generate progress curve (S-curve)
                const progressCurve = this.generateProgressCurve(totalMonths);
                const costCurve = this.generateCostCurve(totalMonths);
                
                let cumulativeReceived = 0;
                let cumulativeSpent = 0;
                let peakCashDeficit = 0;
                
                // Down payment
                const downPaymentAmount = this.inputs.contractValue * (this.inputs.downPayment / 100);
                cumulativeReceived += downPaymentAmount;
                
                for (let month = 0; month < totalMonths; month++) {
                    const monthlyProgress = month === 0 ? progressCurve[0] : progressCurve[month] - progressCurve[month - 1];
                    const monthlyCost = month === 0 ? costCurve[0] : costCurve[month] - costCurve[month - 1];
                    
                    // Calculate monthly billing
                    let monthlyBilling = this.inputs.contractValue * monthlyProgress;
                    
                    // Apply mobilization in first month
                    if (month === 0) {
                        monthlyBilling += this.inputs.contractValue * (this.inputs.mobilizationPercent / 100);
                    }
                    
                    // Calculate retention
                    const retention = monthlyBilling * (this.inputs.retentionRate / 100);
                    const netBilling = monthlyBilling - retention;
                    
                    // Apply payment delay
                    const paymentMonth = month + Math.floor(this.inputs.drawProcessingTime / 30);
                    
                    // Monthly spending
                    const monthlySpending = this.inputs.contractValue * monthlyCost + 
                        (month === 0 ? this.inputs.initialCashOutlay : 0);
                    
                    cumulativeSpent += monthlySpending;
                    
                    // Add payment after delay
                    if (paymentMonth < totalMonths + 6) { // Allow for payment delays beyond project end
                        if (!monthlyData[paymentMonth]) {
                            monthlyData[paymentMonth] = { month: paymentMonth, received: 0, spent: 0, cumReceived: 0, cumSpent: 0, cashFlow: 0 };
                        }
                        monthlyData[paymentMonth].received += netBilling;
                    }
                    
                    // Set monthly data
                    if (!monthlyData[month]) {
                        monthlyData[month] = { month: month, received: 0, spent: 0, cumReceived: 0, cumSpent: 0, cashFlow: 0 };
                    }
                    monthlyData[month].spent += monthlySpending;
                    monthlyData[month].billing = monthlyBilling;
                    monthlyData[month].retention = retention;
                }
                
                // Calculate cumulative and cash flow
                let runningReceived = downPaymentAmount;
                let runningSpent = 0;
                
                for (let i = 0; i < monthlyData.length; i++) {
                    if (monthlyData[i]) {
                        runningReceived += monthlyData[i].received;
                        runningSpent += monthlyData[i].spent;
                        
                        monthlyData[i].cumReceived = runningReceived;
                        monthlyData[i].cumSpent = runningSpent;
                        monthlyData[i].cashFlow = runningReceived - runningSpent;
                        
                        if (monthlyData[i].cashFlow < peakCashDeficit) {
                            peakCashDeficit = monthlyData[i].cashFlow;
                        }
                    }
                }
                
                // Release retention at project completion
                const totalRetention = this.inputs.contractValue * (this.inputs.retentionRate / 100);
                const retentionReleaseMonth = totalMonths + Math.floor(this.inputs.drawProcessingTime / 30);
                if (monthlyData[retentionReleaseMonth]) {
                    monthlyData[retentionReleaseMonth].received += totalRetention;
                    monthlyData[retentionReleaseMonth].cumReceived += totalRetention;
                    monthlyData[retentionReleaseMonth].cashFlow += totalRetention;
                } else {
                    monthlyData[retentionReleaseMonth] = {
                        month: retentionReleaseMonth,
                        received: totalRetention,
                        spent: 0,
                        cumReceived: runningReceived + totalRetention,
                        cumSpent: runningSpent,
                        cashFlow: runningReceived + totalRetention - runningSpent
                    };
                }
                
                this.results.monthlyData = monthlyData;
                this.results.peakCashNeed = Math.abs(peakCashDeficit);
                this.results.totalRetention = totalRetention;
                this.results.averageDrawAmount = (this.inputs.contractValue - downPaymentAmount) / this.results.numberOfDraws;
            }

            getDrawFrequencyInMonths() {
                const frequencies = {
                    'weekly': 0.25,
                    'bi-weekly': 0.5,
                    'monthly': 1,
                    'milestone': 2,
                    'completion': 1
                };
                return frequencies[this.inputs.drawFrequency] || 1;
            }

            generateProgressCurve(months) {
                // Generate typical S-curve for construction progress
                const curve = [];
                for (let i = 0; i <= months; i++) {
                    const t = i / months;
                    let progress;
                    
                    if (t <= 0.1) {
                        // Slow start (mobilization)
                        progress = 0.05 + (this.inputs.frontLoad / 100) * t * 10;
                    } else if (t <= 0.8) {
                        // Linear middle portion
                        progress = 0.05 + (this.inputs.frontLoad / 100) + (t - 0.1) * 0.85 * (1 - this.inputs.frontLoad / 100);
                    } else {
                        // Slow finish (punch list, cleanup)
                        const remaining = 1 - (0.05 + (this.inputs.frontLoad / 100) + 0.7 * 0.85 * (1 - this.inputs.frontLoad / 100));
                        progress = 0.95 + remaining * ((t - 0.8) / 0.2) * 0.5;
                    }
                    
                    curve.push(Math.min(1, progress));
                }
                return curve;
            }

            generateCostCurve(months) {
                // Cost curve typically leads progress curve slightly
                const progressCurve = this.generateProgressCurve(months);
                return progressCurve.map((progress, index) => {
                    // Costs typically occur 0.5-1 month ahead of billing
                    const leadIndex = Math.min(months - 1, index + 0.5);
                    const leadProgress = this.interpolateProgress(progressCurve, leadIndex);
                    return Math.min(1, leadProgress);
                });
            }

            interpolateProgress(curve, index) {
                const floorIndex = Math.floor(index);
                const ceilIndex = Math.ceil(index);
                if (floorIndex === ceilIndex) return curve[floorIndex];
                
                const fraction = index - floorIndex;
                return curve[floorIndex] * (1 - fraction) + curve[ceilIndex] * fraction;
            }

            calculateFinancialMetrics() {
                const monthlyData = this.results.monthlyData;
                const monthlyRate = this.inputs.interestRate / 100 / 12;
                
                // Calculate NPV
                let npv = 0;
                monthlyData.forEach((data, index) => {
                    if (data) {
                        const netCashFlow = data.received - data.spent;
                        npv += netCashFlow / Math.pow(1 + monthlyRate, index);
                    }
                });
                this.results.netPresentValue = npv;
                
                // Calculate working capital requirement
                this.results.workingCapitalReq = this.inputs.contractValue * (this.inputs.workingCapitalDays / 365) * 
                    (this.inputs.laborCostPercent + this.inputs.materialCostPercent + this.inputs.equipmentCostPercent) / 100;
                
                // Calculate interest carrying cost
                let totalInterestCost = 0;
                monthlyData.forEach(data => {
                    if (data && data.cashFlow < 0) {
                        totalInterestCost += Math.abs(data.cashFlow) * (monthlyRate);
                    }
                });
                this.results.interestCarryingCost = totalInterestCost;
                
                // Bond cost
                this.results.bondCost = this.inputs.contractValue * (this.inputs.bondRate / 100);
                
                // Calculate ROI
                const finalCashFlow = monthlyData[monthlyData.length - 1]?.cashFlow || 0;
                const totalCosts = this.inputs.contractValue * 0.85 + this.results.interestCarryingCost + 
                    this.results.bondCost + this.inputs.initialCashOutlay;
                this.results.projectROI = ((finalCashFlow - this.inputs.initialCashOutlay) / totalCosts) * 100;
                this.results.finalProfit = finalCashFlow;
                
                // Breakeven point
                let breakevenMonth = 0;
                for (let i = 0; i < monthlyData.length; i++) {
                    if (monthlyData[i] && monthlyData[i].cashFlow > 0) {
                        breakevenMonth = i;
                        break;
                    }
                }
                this.results.breakevenPoint = breakevenMonth;
                
                // Cash conversion cycle
                this.results.cashConversionCycle = this.inputs.workingCapitalDays + this.inputs.drawProcessingTime;
                
                // Simple IRR approximation
                const totalReturn = finalCashFlow / this.inputs.initialCashOutlay;
                const projectYears = this.inputs.projectDuration / 12;
                this.results.internalRateOfReturn = (Math.pow(totalReturn, 1 / projectYears) - 1) * 100;
                
                // Payback period
                this.results.paybackPeriod = breakevenMonth;
            }

            analyzeRisks() {
                const riskDiv = document.getElementById('riskAnalysis');
                const risks = [];
                
                // Schedule delay risk
                const delayRiskFactors = {
                    'low': { probability: 0.1, impact: 1.1 },
                    'moderate': { probability: 0.3, impact: 1.25 },
                    'high': { probability: 0.5, impact: 1.5 },
                    'very-high': { probability: 0.7, impact: 2.0 }
                };
                
                const delayRisk = delayRiskFactors[this.inputs.delayRisk];
                if (delayRisk.probability > 0.2) {
                    risks.push({
                        type: 'warning',
                        title: 'Schedule Delay Risk',
                        description: `${(delayRisk.probability * 100).toFixed(0)}% chance of delays extending project ${((delayRisk.impact - 1) * 100).toFixed(0)}% longer.`,
                        impact: `Potential additional cost: $${(this.inputs.contractValue * (delayRisk.impact - 1) * 0.3).toLocaleString()}`
                    });
                }
                
                // Payment risk
                const paymentRiskFactors = {
                    'low': { probability: 0.05, impact: 1.1 },
                    'moderate': { probability: 0.15, impact: 1.3 },
                    'high': { probability: 0.3, impact: 1.5 },
                    'very-high': { probability: 0.5, impact: 2.0 }
                };
                
                const paymentRisk = paymentRiskFactors[this.inputs.paymentRisk];
                if (paymentRisk.probability > 0.1) {
                    risks.push({
                        type: 'warning',
                        title: 'Payment Risk',
                        description: `${(paymentRisk.probability * 100).toFixed(0)}% chance of payment delays or disputes.`,
                        impact: `Potential cash flow impact: $${(this.results.peakCashNeed * 0.5).toLocaleString()}`
                    });
                }
                
                // Cash flow risk
                if (this.results.peakCashNeed > this.inputs.contractValue * 0.2) {
                    risks.push({
                        type: 'error',
                        title: 'High Cash Flow Risk',
                        description: 'Peak cash requirement exceeds 20% of contract value.',
                        impact: `Line of credit needed: $${this.results.peakCashNeed.toLocaleString()}`
                    });
                }
                
                // Change order risk
                if (this.inputs.changeOrderPercent > 10) {
                    risks.push({
                        type: 'warning',
                        title: 'Change Order Risk',
                        description: 'High expected change order percentage may affect cash flow timing.',
                        impact: `Potential scope increase: $${(this.inputs.contractValue * this.inputs.changeOrderPercent / 100).toLocaleString()}`
                    });
                }
                
                // Low margin risk
                if (this.results.projectROI < 10) {
                    risks.push({
                        type: 'error',
                        title: 'Low Profitability Risk',
                        description: 'Project ROI is below industry standards.',
                        impact: 'Consider renegotiating terms or reassessing costs'
                    });
                }
                
                let html = '';
                risks.forEach(risk => {
                    const iconClass = risk.type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle';
                    html += `
                        <div class="risk-item ${risk.type}">
                            <div class="risk-header">
                                <i class="${iconClass}"></i>
                                <strong>${risk.title}</strong>
                            </div>
                            <div class="risk-description">${risk.description}</div>
                            <div class="risk-impact">${risk.impact}</div>
                        </div>
                    `;
                });
                
                if (risks.length === 0) {
                    html = '<div class="risk-item success"><i class="fas fa-check-circle"></i><strong>Low Risk Profile</strong><div>Project shows manageable risk levels across all categories.</div></div>';
                }
                
                riskDiv.innerHTML = html;
            }

            generateOptimizationTips() {
                const tipsDiv = document.getElementById('optimizationTips');
                const tips = [];
                
                // Cash flow optimization
                if (this.results.peakCashNeed > this.inputs.contractValue * 0.15) {
                    tips.push({
                        icon: 'fas fa-coins',
                        title: 'Negotiate Better Payment Terms',
                        description: 'Consider requesting higher down payment or shorter payment cycles to reduce peak cash requirements.'
                    });
                }
                
                if (this.inputs.retentionRate > 5) {
                    tips.push({
                        icon: 'fas fa-percentage',
                        title: 'Optimize Retention Rate',
                        description: 'Negotiate lower retention percentage or earlier release schedule to improve cash flow.'
                    });
                }
                
                if (this.inputs.drawProcessingTime > 30) {
                    tips.push({
                        icon: 'fas fa-clock',
                        title: 'Streamline Draw Process',
                        description: 'Work with owner to establish faster draw processing procedures and electronic submissions.'
                    });
                }
                
                // Front-loading opportunities
                if (this.inputs.frontLoad < 5) {
                    tips.push({
                        icon: 'fas fa-rocket',
                        title: 'Consider Front-Loading',
                        description: 'Strategic front-loading of early activities can improve cash flow timing without affecting costs.'
                    });
                }
                
                // Material management
                tips.push({
                    icon: 'fas fa-truck',
                    title: 'Optimize Material Delivery',
                    description: 'Negotiate payment terms with suppliers that align with your draw schedule to minimize working capital.'
                });
                
                // Financial instruments
                if (this.results.peakCashNeed > 100000) {
                    tips.push({
                        icon: 'fas fa-university',
                        title: 'Consider Financial Instruments',
                        description: 'Explore factoring, progress payment financing, or equipment financing to reduce cash flow pressure.'
                    });
                }
                
                let html = '';
                tips.forEach(tip => {
                    html += `
                        <div class="tip-item">
                            <div class="tip-icon"><i class="${tip.icon}"></i></div>
                            <div class="tip-content">
                                <div class="tip-title">${tip.title}</div>
                                <div class="tip-description">${tip.description}</div>
                            </div>
                        </div>
                    `;
                });
                
                tipsDiv.innerHTML = html;
            }

            displayResults() {
                // Cash Flow Summary
                document.getElementById('peakCashNeed').textContent = `$${this.results.peakCashNeed.toLocaleString()}`;
                document.getElementById('projectROI').textContent = `${this.results.projectROI.toFixed(1)}%`;
                document.getElementById('breakevenPoint').textContent = `Month ${this.results.breakevenPoint}`;
                document.getElementById('finalProfit').textContent = `$${this.results.finalProfit.toLocaleString()}`;
                
                // Draw Schedule Analysis
                document.getElementById('numberOfDraws').textContent = this.results.numberOfDraws;
                document.getElementById('averageDrawAmount').textContent = `$${this.results.averageDrawAmount.toLocaleString()}`;
                document.getElementById('totalRetention').textContent = `$${this.results.totalRetention.toLocaleString()}`;
                document.getElementById('cashConversionCycle').textContent = `${this.results.cashConversionCycle} days`;
                
                // Financial Metrics
                document.getElementById('netPresentValue').textContent = `$${this.results.netPresentValue.toLocaleString()}`;
                document.getElementById('internalRateOfReturn').textContent = `${this.results.internalRateOfReturn.toFixed(1)}%`;
                document.getElementById('paybackPeriod').textContent = `${this.results.paybackPeriod} months`;
                document.getElementById('workingCapitalReq').textContent = `$${this.results.workingCapitalReq.toLocaleString()}`;
                document.getElementById('interestCarryingCost').textContent = `$${this.results.interestCarryingCost.toLocaleString()}`;
                document.getElementById('bondCost').textContent = `$${this.results.bondCost.toLocaleString()}`;
                
                // Display charts and tables
                this.displayCashFlowChart();
                this.displayDrawScheduleTable();
            }

            displayCashFlowChart() {
                const chartDiv = document.getElementById('cashFlowChart');
                const monthlyData = this.results.monthlyData;
                
                // Create a simple text-based chart representation
                let html = '<div class="chart-header">Monthly Cash Flow Position</div>';
                html += '<div class="chart-legend"><span class="legend-received">■ Received</span><span class="legend-spent">■ Spent</span><span class="legend-cumulative">— Cumulative</span></div>';
                html += '<div class="chart-data">';
                
                const maxValue = Math.max(...monthlyData.map(d => d ? Math.max(d.received, d.spent, Math.abs(d.cashFlow)) : 0));
                
                monthlyData.slice(0, Math.ceil(this.inputs.projectDuration) + 3).forEach((data, index) => {
                    if (data) {
                        const receivedBar = Math.round((data.received / maxValue) * 50);
                        const spentBar = Math.round((data.spent / maxValue) * 50);
                        const cashFlowIndicator = data.cashFlow >= 0 ? '✓' : '⚠';
                        
                        html += `
                            <div class="chart-month">
                                <div class="month-label">Month ${index + 1}</div>
                                <div class="chart-bars">
                                    <div class="bar received" style="width: ${receivedBar}px" title="Received: $${data.received.toLocaleString()}"></div>
                                    <div class="bar spent" style="width: ${spentBar}px" title="Spent: $${data.spent.toLocaleString()}"></div>
                                </div>
                                <div class="cash-flow-indicator ${data.cashFlow >= 0 ? 'positive' : 'negative'}">
                                    ${cashFlowIndicator} $${data.cashFlow.toLocaleString()}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                chartDiv.innerHTML = html;
            }

            displayDrawScheduleTable() {
                const tableDiv = document.getElementById('drawScheduleTable');
                const monthlyData = this.results.monthlyData;
                
                let html = `
                    <table class="draw-schedule-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Work Progress</th>
                                <th>Billing Amount</th>
                                <th>Retention</th>
                                <th>Net Payment</th>
                                <th>Payment Date</th>
                                <th>Cash Position</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const startDate = new Date(this.inputs.projectStart);
                
                monthlyData.slice(0, Math.ceil(this.inputs.projectDuration) + 2).forEach((data, index) => {
                    if (data) {
                        const paymentDate = new Date(startDate);
                        paymentDate.setMonth(paymentDate.getMonth() + index + Math.floor(this.inputs.drawProcessingTime / 30));
                        
                        const progressPercent = ((data.cumSpent / this.inputs.contractValue) * 100).toFixed(1);
                        
                        html += `
                            <tr class="${data.cashFlow < 0 ? 'negative-cash' : 'positive-cash'}">
                                <td>${index + 1}</td>
                                <td>${progressPercent}%</td>
                                <td>$${(data.billing || 0).toLocaleString()}</td>
                                <td>$${(data.retention || 0).toLocaleString()}</td>
                                <td>$${data.received.toLocaleString()}</td>
                                <td>${paymentDate.toLocaleDateString()}</td>
                                <td class="${data.cashFlow >= 0 ? 'positive' : 'negative'}">$${data.cashFlow.toLocaleString()}</td>
                            </tr>
                        `;
                    }
                });
                
                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            }

            printResults() {
                const printWindow = window.open('', '_blank');
                const printContent = `
                    <html>
                    <head>
                        <title>Project Cash Flow Analysis - ${this.inputs.projectName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 20px; }
                            .section h3 { color: #2c5282; border-bottom: 2px solid #2c5282; padding-bottom: 5px; }
                            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
                            .metrics-table { width: 100%; border-collapse: collapse; }
                            .metrics-table th, .metrics-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                            .highlight { background: #e6fffa; padding: 10px; border-radius: 5px; }
                            .warning { background: #fff5f5; border-left: 4px solid #f56565; padding: 10px; margin: 10px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>Project Cash Flow Analysis</h2>
                            <p><strong>${this.inputs.projectName}</strong></p>
                            <p>Contract Value: $${this.inputs.contractValue.toLocaleString()} | Duration: ${this.inputs.projectDuration} months</p>
                            <p>Generated: ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <div class="section">
                            <h3>Executive Summary</h3>
                            <div class="highlight">
                                <div><strong>Peak Cash Need:</strong> $${this.results.peakCashNeed.toLocaleString()}</div>
                                <div><strong>Project ROI:</strong> ${this.results.projectROI.toFixed(1)}%</div>
                                <div><strong>Breakeven Point:</strong> Month ${this.results.breakevenPoint}</div>
                                <div><strong>Final Profit:</strong> $${this.results.finalProfit.toLocaleString()}</div>
                                <div><strong>Net Present Value:</strong> $${this.results.netPresentValue.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>Cash Flow Parameters</h3>
                            <div class="grid">
                                <div>Draw Frequency: ${this.inputs.drawFrequency}</div>
                                <div>Retention Rate: ${this.inputs.retentionRate}%</div>
                                <div>Processing Time: ${this.inputs.drawProcessingTime} days</div>
                                <div>Working Capital: ${this.inputs.workingCapitalDays} days</div>
                                <div>Interest Rate: ${this.inputs.interestRate}%</div>
                                <div>Bond Rate: ${this.inputs.bondRate}%</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>Financial Metrics</h3>
                            <table class="metrics-table">
                                <tr><th>Metric</th><th>Value</th></tr>
                                <tr><td>Internal Rate of Return (IRR)</td><td>${this.results.internalRateOfReturn.toFixed(1)}%</td></tr>
                                <tr><td>Payback Period</td><td>${this.results.paybackPeriod} months</td></tr>
                                <tr><td>Working Capital Requirement</td><td>$${this.results.workingCapitalReq.toLocaleString()}</td></tr>
                                <tr><td>Interest Carrying Cost</td><td>$${this.results.interestCarryingCost.toLocaleString()}</td></tr>
                                <tr><td>Bond Cost</td><td>$${this.results.bondCost.toLocaleString()}</td></tr>
                                <tr><td>Total Retention</td><td>$${this.results.totalRetention.toLocaleString()}</td></tr>
                            </table>
                        </div>
                        
                        ${this.results.projectROI < 10 || this.results.peakCashNeed > this.inputs.contractValue * 0.2 ? 
                            '<div class="warning"><strong>⚠️ ATTENTION REQUIRED</strong><br>Project shows low profitability or high cash flow risk. Review terms and pricing.</div>' : ''}
                        
                        <div class="section">
                            <h3>Assumptions & Disclaimers</h3>
                            <p><strong>Key Assumptions:</strong></p>
                            <ul>
                                <li>Progress follows typical S-curve pattern</li>
                                <li>No major change orders or delays</li>
                                <li>Payment terms honored by owner</li>
                                <li>Material and labor costs remain stable</li>
                            </ul>
                            <p><strong>Disclaimer:</strong> This analysis provides estimates for planning purposes. Actual results may vary based on project execution, market conditions, and unforeseen circumstances.</p>
                        </div>
                    <script defer>
    document.getElementById('btn-print')?.addEventListener('click', () => window.print());
</script>
</body>
                    </html>
                `;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
            }
        }

        // Initialize calculator
        const calculator = new ProjectCashFlowCalculator();
    </script>
<script defer>
    document.getElementById('btn-print')?.addEventListener('click', () => window.print());
</script>
</body>
</html>